blue = V4 0 0 1 1
clear = FrameBuffer $ ColorImage @1 $ V4F 1 0 0 0.5

triangleRasterCtx = TriangleCtx CullNone PolygonFill NoOffset LastVertex
colorFragmentCtx = AccumulationContext (ColorOp NoBlending (V4B True True True True))

rasterizeWith = Rasterize
triangles = triangleRasterCtx

quadVertexStream = Fetch "quad" Triangles (IV4F "position")

transform s f =  Transform (\v -> VertexOut (f v) 1 () (Smooth v)) s

scale t v = v `PrimMul` V4 t t t 1
const x y = x
x & f = f x

mapFragments s fs = Accumulate colorFragmentCtx PassAll (\a -> FragmentOut $ fs a) s clear

render f = quadVertexStream                 -- id vertices
    `transform`    id
     &             rasterizeWith triangles  -- rasterize
    `mapFragments` f
     &             ScreenOut                --  draw into screen

a < b = a `PrimLessThan` b
a - b = a `PrimSubS` b

fun x = if x < 0 then 0 else x + fun (x - 0.3)

main = render $ \c -> if fun c%r < 0.5 then c else blue
