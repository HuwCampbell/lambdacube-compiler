clear = FrameBuffer $ (DepthImage @1 1000, ColorImage @1 navy)   -- ...

triangleRasterCtx = TriangleCtx CullNone PolygonFill NoOffset LastVertex
colorFragmentCtx = AccumulationContext (DepthOp Less True, ColorOp NoBlending (V4 True True True True))

rasterizeWith = Rasterize
triangles = triangleRasterCtx

cubeVertexStream = fetch "stream4" Triangle (Attribute "position4" :: Vec 4 Float, Attribute "vertexUV" :: Vec 2 Float)
mapFragments s fs = accumulate colorFragmentCtx PassAll (FragmentShaderRastDepth $ \a -> fs a) s clear
transform s f =  Transform (\(v,u) -> VertexOut (f v) 1 () (Smooth u)) s

rotate' v = (Uniform "MVP" :: Mat 4 4 Float) *. v

cube' fb =             cubeVertexStream         -- cube vertices
    `transform`    id    -- scale them
     &             rasterizeWith triangles  -- rasterize
    `mapFragments` (\a -> blue)
  where sampler = Sampler LinearFilter MirroredRepeat $ Texture2D (V2 1024 768) (PrjImageColor fb)

iterate :: (a -> a) -> a -> [a]
iterate f x =  x : iterate f (f x)

(!!) :: [a] -> Int -> a
(x : _)  !! 0         =  x
(_ : xs) !! n         =  xs !! (n-!1)

main :: Output
main = ScreenOut (iterate cube' clear !! 5)
